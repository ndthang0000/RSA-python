<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
            //check login
        let isLogin=JSON.parse(localStorage.getItem('isLogin'))
        if(!isLogin){
            window.location.href=window.location.pathname.replace('index','login')
        }
    </script>
    <title>The One - abum</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="shortcut icon" href="assets/image/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="bg-image">
        <!-- header -->
        <header class="header bg-white" style="box-shadow: -1px 7px 14px 4px rgba(101,101,101,0.40);">
            <div class="container" style="align-items: center;">
                <div class="row">
                    <div class="col-3 header-logo" style="color: #555;">
                        <img src="./assets//image/icon.png" width="50px" alt="">
                        <span class="name">
                            THE ONE
                        </span>
                    </div>
                    <div class="col-6 menu-list">
                        <li ><a href="./index.html" >Xem abum ảnh</a></li>
                        <li> <a href="./upload.html">Tải ảnh lên</a> </li>
                    </div>
                    <div class="col-3 image-area-avatar">
                        <div class="image-area">
                            <img src="./assets/image/avatar.png" width="100%"  alt="" class="img-avatar">
                        </div>
                        <div class="list-item ds-none-block">
                            <li><a href="./login.html" id="log-out">Đăng xuất</a></li>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div class="side-bar-menu">
            <div>
                <li style="font-size: 20px;padding: 5px 10px;margin: 5px;"><a href="./index.html" >Xem abum ảnh</a></li>
                <li style="font-size: 20px;padding: 5px 10px;margin: 5px;"> <a href="./upload.html">Tải ảnh lên</a> </li>
            </div>
        </div>
        <!-- content -->
        <div class="content">
            <div class="container bg-light" style="padding: 50px; border-radius: 10px;margin-top: 100px;position: relative;">
                <div class="abum">
                    <div class=" title-content text-center" >
                        <i class="bi bi-image" style="color: #1e90ff;"></i>
                        Abum ảnh của bạn
                    </div>
                </div>
                <div style="margin-top: 50px;padding: 20px;">
                    <button type="button" class="btn btn-success">
                        <i class="bi bi-download"></i>
                        Tải xuống tất cả các ảnh
                    </button>
                    <button type="button" class="btn btn-nomarl">
                        <i class="bi bi-file-arrow-down"></i>
                        Tải xuống ảnh đã chọn
                    </button>
                </div>
                <div class="row image-list ms-2" style="margin-top: 50px;">
                    
                    
                </div>
            </div>
        </div>
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Chia sẻ ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="" style="display: block;margin-left: 4px;font-size: 18px;font-weight: 550;margin-bottom: 10px;">Username</label>
                <input type="text" placeholder="Nhập username..." style="padding: 4px 8px;outline: none;border: none;border-bottom:1px solid #1e90ff ;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
            </div>
        </div>
        </div>
        <!-- footer -->
        <footer class="footer mt-1 bg-dark">
            <div class="container ">
                <div class="text-center text-white row">
                    <div class="mt-3">
                        <p class="text-footer"><i class="bi bi-boxes"></i> Đồ án được thực hiện bởi nhóm THE ONE </p>
                    </div>
                </div>
            </div>
        </footer>
        <div id="canvas"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="./assets/js/main.js"></script>
    <script>
    
    let liseImage=document.querySelector('.image-list')
    let canvasEl=document.querySelector('#canvas')
    let token=localStorage.getItem('token')
    fetch('http://localhost:5000/api/my-image',{
        headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        method: "GET",
    })
    .then(res=>res.json())
    .then(res=>{
        
        let canvasHtml=''
        for(let i=0;i<res.length;i++){
            canvasHtml+=`<canvas class="canvas" style="display:none"></canvas>`
        }
        canvasEl.innerHTML=canvasHtml
        let allCanvas=document.querySelectorAll('.canvas')
        for(let i=0;i<res.length;i++){
            allCanvas[i].height=res[i].height
            allCanvas[i].width=res[i].width
            let ctx=allCanvas[i].getContext('2d')
            ctx.fillStyle = "red";
            ctx.fillRect(0, 0, res[i].width, res[i].height);
            var imgData = ctx.getImageData(0, 0, res[i].width, res[i].height);

            var bytes  = CryptoJS.AES.decrypt(res[i].ciphertext, 'secret key 123');
            var originalText = bytes.toString(CryptoJS.enc.Utf8);
            let arrIamgeEncrypt=canvasStringToArr(originalText)
            for(let j=0;j<imgData.data.length;j+=4){
                imgData.data[j]=arrIamgeEncrypt[j]
                imgData.data[j+1]=arrIamgeEncrypt[j+1]
                imgData.data[j+2]=arrIamgeEncrypt[j+2]
                imgData.data[j+3]=255
            }
            ctx.putImageData(imgData, 0, 0);
            var url = allCanvas[i].toDataURL();
            res[i].src=url
        }

        
        console.log(res)
        let html=res.map(item=>{
            return `<div class="col-lg-3 col-md-4 col-sm-6" style="margin-bottom:15px">
                        <div class="card" style="width: 100%;">
                            <img src="${item.src}" class="card-img-top" alt="..." style="width:100%;height:auto">
                            <div class="card-body">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text" style="color: #888;">Ngày đăng: ${moment(item.createdAt.$date).format('lll')}</p>
                                <a href="${item.src}" download="" class="btn btn-primary"> 
                                    <i class="bi bi-box-arrow-in-down" style="margin-right: 5px;"></i>
                                    Tải xuống</a>
                            </div>
                            <i class="bi bi-share-fill" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-username="1" data-bs-imageid="${item._id}" ></i>
                        </div>
                    </div>`
        }).join(' ')
        liseImage.innerHTML=html

        var exampleModal = document.getElementById('exampleModal')
        exampleModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget
            var recipient = button.getAttribute('data-bs-username')
            console.log(recipient)
        })
    })

// Decrypt
// var bytes  = CryptoJS.AES.decrypt(ciphertext, 'secret key 123');
// var originalText = bytes.toString(CryptoJS.enc.Utf8);

// console.log(originalText); // 'my message'
    </script>
</body>
</html>